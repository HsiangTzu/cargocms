var summernoteImageUpload = function () {
  console.log('load summernoteImageUpload');
  $('.summernote').summernote({
    height: 180,
    dialogsInBody: true,
    lang: 'zh-TW',
    maximumImageFileSize: 2 * 1024 * 1024,
    toolbar: [
      ['style', ['bold', 'italic', 'underline', 'clear']],
      ['fontsize', ['fontsize']],
      ['color', ['color']],
      ['insert', ['picture', 'link']],
      ['para', ['ul', 'ol', 'paragraph']],
      ['misc', ['redo', 'undo', 'fullscreen']],
    ],
    callbacks: {
      onInit: function() {
        var self = this;
        setTimeout(function () {
          $(self).summernote('code', self.innerText);
          if(document.querySelector('.loading-wrapper.active'))
            document.querySelector('.loading-wrapper.active').classList.remove('active');
        }, 3000);
      },
      onImageUpload: function(files) {
        console.log('onImageUpload');
        function onerror (err) {
          console.error(err);
          alert('錯誤，發生不明原因，無法上傳圖片。')
        }
        if(this.maximumImageFileSize < files[0].size) {
          messageApp.show({desc: '上傳圖片超過限制', type: 'error'});
        }
        var self = this;
        var formdata = new FormData();
        formdata.append('qquuid', files[0].name);
        formdata.append('qqfilename', files[0].name);
        formdata.append('qqtotalfilesize', files[0].size);
        formdata.append('uploadPic', files[0]);
        var xhr = new XMLHttpRequest();
        xhr.open('post', '/api/admin/upload');
        xhr.onload = function () {
          try {
            var json = JSON.parse(xhr.responseText);
            $(self).summernote('insertImage', json.data.url);
            console.log('json.data.url=>', json.data.url);
          } catch (err) {
            onerror(err);
          }
        };
        xhr.onerror = onerror;
        xhr.send(formdata);
      }
    }
  });

  if($('form')[0])
    $('form')[0].onsubmit =function (event) {
      var summernotes = $('.summernote');
      summernotes.each(function (index) {
        var summernote = summernotes.eq(index);
        var markup = summernote.summernote('code');
        appMain.data.item[summernote.attr('name')] = markup;
      });
      return true;
    };
};
