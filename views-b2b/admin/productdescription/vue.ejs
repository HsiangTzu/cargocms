var COMMON = {
  DOUBLE_CLICK_TIME_PERIOD: 250,
  DEFAULT_INDEX: -1,
  DEFAULT_AVATAR: "/assets/admin/img/avatars/default.png",
};

var itemBeforeEdit = {};
var prefix = 'admin/';
var modelName = "productdescription";
var appModel = {
  modelName: modelName,
  prefix: prefix,
  data: {
    item: {
      id: '',
      name: '',
      description: '',
      tag: '',
      metaTitle: '',
      metaDescription: '',
      metaKeyword: '',
      shippingData: '',
      specification: '',
      story: '',
      precautions: '',
    },
    items: [],
    option: {
      defaultSort: [[ 6, 'desc' ]],
      productList: [],
    }
  },
  view: {
    table: {
      selectIndex: COMMON.DEFAULT_INDEX,
    },
  }
}

var ready = function () {
  setTimeout(function () {
    $('.summernote').summernote({
      height: 180,
      dialogsInBody: true,
      lang: 'zh-TW',
      toolbar: [
        ['style', ['bold', 'italic', 'underline', 'clear']],
        ['fontsize', ['fontsize']],
        ['color', ['color']],
        ['insert', ['picture', 'link']],
        ['para', ['ul', 'ol', 'paragraph']],
        ['misc', ['redo', 'undo', 'fullscreen']],
      ],
      callbacks: {
        onInit: function() {
          $(this).summernote('code', this.innerText);
          if(document.querySelector('.spinner'))
            document.querySelector('.spinner').classList.remove('spinner');
        },
        onImageUpload: function(files) {
        
          function onerror (err) {
            console.error(err);
            swal('錯誤', '發生不明原因，無法上傳圖片。', 'error');
          }
          var self = this;
          var formdata = new FormData();
          formdata.append('qquuid', files[0].name); 
          formdata.append('qqfilename', files[0].name); 
          formdata.append('qqtotalfilesize', files[0].size); 
          formdata.append('uploadPic', files[0]); 
          var xhr = new XMLHttpRequest();
          xhr.open('post', '/api/admin/upload');
          xhr.onload = function () {
            try {
              var json = JSON.parse(xhr.responseText);
              $(self).summernote('insertImage', json.data.url);
            } catch (err) {
              onerror(err);
            }
          };
          xhr.onerror = onerror;
          xhr.send(formdata);
        }
      }
    });
  
    $('form')[0].onsubmit = function (event) { 
      var summernotes = $('.summernote');
      summernotes.each(function (index) {
        var summernote = summernotes.eq(index);
        var markup = summernote.summernote('code'); 
        appMain.data.item[summernote[0].getAttribute('name')] = markup;
      });
    };
  }, 3000);
}

/* TABLETOOLS */

<%- include ../default/vue.ejs %>
// 需要新增函式可以對 appMain 進行定義，如：
// appMain.log = function () {console.log("123")}

appMain.enableText = function () {
  $('textarea').attr('disabled', false);
};

appMain.enableSelect = function () {
	$('select').attr('disabled', false);
	$('.select').removeClass('state-disabled');
};

appMain.loadProduct = function () {

  $.get('/api/admin/product', ajaxSuccess);

  function ajaxSuccess(result) {
    if (result.success) {
      appModel.data.option.productList = result.data.items;
    }
  } // end ajaxSuccess
};